#!/bin/bash

function getDevice() {
  xinput | grep -E 'slave.*keyboard' | head -n 1 | sed -re 's/^.*id=([0-9]+).*$/\1/'
}

EVDEVICE=/dev/input/event$(getDevice)

function nextTab() {
  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_LEFTSHIFT --value 0 --sync

  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_LEFTCTRL --value 1 --sync
  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_PAGEDOWN --value 1 --sync
  
  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_PAGEDOWN --value 0 --sync
}

function prevTab() {
  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_LEFTSHIFT --value 0 --sync

  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_LEFTCTRL --value 1 --sync
  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_PAGEUP --value 1 --sync

  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_LEFTSHIFT --value 1 --sync
  sudo evemu-event $EVDEVICE --type EV_KEY --code KEY_PAGEUP --value 0 --sync

}

function execute() {
  case "$1" in
    next-tab)
      nextTab
      ;;
      
    prev-tab)
      prevTab
      ;;
    *)
      echo $"Usage: $0 {next-tab|prev-tab}"
      exit 1
  esac
}

(
  # Wait for lock on /var/lock/.myscript.exclusivelock (fd 200) for 10 seconds
  flock -x -w 0.1 200 || exit 1

  execute "$@"

) 200>/tmp/.exec-key-command.exclusivelock
